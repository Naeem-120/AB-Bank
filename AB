WITH T1_CTE AS (
    SELECT 
        LSBRNM || LSDLP || LSDLR AS UNIQID,
        SUM(LSAMTD) AS SCHEDULE_AMT,
        SUM(LSAMTP) AS PAID_AMT,
        SUM(LSAMTD) - SUM(LSAMTP) AS OUTSTANDING_AMT
    FROM KFILPMO.LSPF
    WHERE LSMVT = 'P'
    GROUP BY LSBRNM, LSDLP, LSDLR
),

T2_CTE AS (
    SELECT 
        LSBRNM || LSDLP || LSDLR AS UNIQID,
        LSAMTD AS REPAYMENT_AMT
    FROM KFILPMO.LSPF A
    WHERE LSMVT = 'P'
      AND LSDTE = (
            SELECT MAX(LSDTE)
            FROM KFILPMO.LSPF B
            WHERE LSMVT = 'P' 
              AND A.LSBRNM = B.LSBRNM 
              AND A.LSDLP = B.LSDLP 
              AND A.LSDLR = B.LSDLR
        )
),

T3_CTE AS (
    SELECT  
        LSBRNM || LSDLP || LSDLR AS UNIQID,
        MIN(LSDTE) AS EarliestDate,
        MAX(T4PDAT) AS SystemDate -- Use MAX to avoid ambiguity with T4PF
    FROM KFILPMO.LSPF AS G
    LEFT JOIN KFILPMO.T4PF AS B ON 1=1 -- Still using Cartesian join for T4PF
    WHERE (LSAMTP <> LSAMTD OR LSUP <> 0)
      AND LSLSC NOT IN ('','00', 'AC', 'SP', 'EA', 'WL')
    GROUP BY G.LSBRNM, G.LSDLP, G.LSDLR
),

H1_CTE AS (
    SELECT 
        H1BRNM || H1LNP || H1DLR AS DEALUNQID,
        MAX(CASE WHEN H1LSC IN ('AC', 'BQ', 'DQ', 'EA', 'SM', 'SP','SQ','WL') THEN H1LSC ELSE ' ' END) AS CLQlJ,
        MAX(CASE WHEN H1LSC IN ('00', '01', '30', '60', '90', 'XX', 'SS', 'DF' , 'BL') THEN H1LSC ELSE ' ' END) AS CLOBJ,
        MAX(CASE WHEN H1MAN = 'Y' THEN H1MAN ELSE ' ' END) AS MANUAL
    FROM KFILPMO.H1PF
    GROUP BY H1BRNM, H1LNP, H1DLR
),

OM_CTE AS (
    SELECT 
        OMBRNM || OMDLP || OMDLR AS DEALUNQUEID,
        SUM(OMNWP) AS DISBURSEDAMOUNT
    FROM KFILPMO.OMPF AS A
    INNER JOIN KFILPMO.V5PF AS B 
        ON A.OMBRNM = B.V5BRNM 
        AND A.OMDLP = B.V5DLP 
        AND A.OMDLR = B.V5DLR
    WHERE A.OMMVT = 'P' 
      AND A.OMMVTS IN ('C', 'O') 
      AND A.OMPRF = 'P' 
      AND B.V5ARC = '' 
      AND B.V5TDT = 'L'
    GROUP BY A.OMBRNM, A.OMDLP, A.OMDLR
)

SELECT 
    T1.UNIQID,
    COALESCE(T1.SCHEDULE_AMT, 0.00) AS SCHEDULE_AMT,
    COALESCE(T1.PAID_AMT, 0.00) AS PAID_AMT,
    T1.OUTSTANDING_AMT,
    COALESCE(T2.REPAYMENT_AMT, 0.00) AS REPAYMENT_AMT,
    COALESCE(T3.EarliestDate, 0) AS EarliestOvdDate,
    COALESCE(T3.SystemDate, 0) AS SystemDate,
    H1.CLOBJ,
    H1.CLQlJ,
    H1.MANUAL,
    COALESCE(OM.DISBURSEDAMOUNT, 0.00) AS DISBURSEDAMOUNT
FROM T1_CTE AS T1
LEFT JOIN T2_CTE AS T2 ON T1.UNIQID = T2.UNIQID
LEFT JOIN T3_CTE AS T3 ON T1.UNIQID = T3.UNIQID 
LEFT JOIN H1_CTE AS H1 ON T1.UNIQID = H1.DEALUNQID
LEFT JOIN OM_CTE AS OM ON T1.UNIQID = OM.DEALUNQUEID
