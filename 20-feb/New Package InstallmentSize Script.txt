WITH RankedData AS (
    SELECT  
        (OMBRNM || OMDLP || OMDLR) AS UNIQID,  
        OMDTE AS Ref_DATE,
        SUM(
            CASE 
                WHEN IZYCPI = 'N' AND OMMVT = 'I' THEN OMNWR
                WHEN IZYCPI = 'N' AND OMMVT = 'P' THEN OMNWR
                WHEN IZYCPI = 'Y' AND OMMVT = 'P' THEN OMNWR
                ELSE 0 
            END
        ) AS CALCULATED_REPAYMENT_AMT,
        (SELECT MAX(T4PDAT) FROM KFILLIV.T4PF) AS SYSTEM_DATE,
        ROW_NUMBER() OVER (
            PARTITION BY (OMBRNM || OMDLP || OMDLR) 
            ORDER BY ABS(OMDTE - (SELECT MAX(T4PDAT) FROM KFILLIV.T4PF)) ASC
        ) AS RN
    FROM KFILLIV.OMPF 
    INNER JOIN KFILLIV.V5PF 
        ON OMBRNM = V5BRNM 
        AND OMDLP = V5DLP 
        AND OMDLR = V5DLR
    INNER JOIN (
        SELECT DISTINCT IZBRNM, IZDLP, IZDLR, IZYCPI
        FROM KFILLIV.IZPF
    ) AS IZPF 
        ON IZPF.IZBRNM = V5BRNM 
        AND IZPF.IZDLP = V5DLP 
        AND IZPF.IZDLR = V5DLR
    LEFT JOIN KFILLIV.T4PF ON 1=1
    WHERE 
        V5TDT = 'L' 
        AND V5ARC = ''
        AND OMMVT IN ('P', 'I') 
        AND OMMVTS IN ('', 'R', 'T')
        AND OMDTE <> 9999999
    GROUP BY OMBRNM, OMDLP, OMDLR, OMDTE
)
SELECT 
    R.UNIQID, 
    R.Ref_DATE, 
    COALESCE(NULLIF(R.CALCULATED_REPAYMENT_AMT, 0), L.LSPF_REPAYMENT_AMT) AS REPAYMENT_AMT,
    R.SYSTEM_DATE
FROM RankedData R
LEFT JOIN (
    SELECT 
        LSBRNM,LSDLP,LSDLR, 
        MAX(LSAMTD) AS LSPF_REPAYMENT_AMT
    FROM KFILLIV.LSPF
    GROUP BY LSBRNM,LSDLP,LSDLR
) L ON R.UNIQID = (LSBRNM || LSDLP || LSDLR) -- Adjust JOIN condition based on actual structure
WHERE R.RN = 1
