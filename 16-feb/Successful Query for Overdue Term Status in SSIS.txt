SELECT *
FROM (
    SELECT 
        T1.UNIQID,
        COALESCE(T1.SCHEDULE_AMT, 0.00) AS SCHEDULE_AMT,
        COALESCE(T1.PAID_AMT, 0.00) AS PAID_AMT,
        COALESCE(T1.OUTSTANDING_AMT, 0.00) AS OUTSTANDING_AMT,
        COALESCE(T2.REPAYMENT_AMT, 0.00) AS REPAYMENT_AMT,
        COALESCE(T3.EARLIEST_DATE, 0) AS EARLIEST_OVD_DATE,
        COALESCE(T3.SYSTEM_DATE, 0) AS SYSTEM_DATE,
        COALESCE(H1.CLOBJ, ' ') AS CLOBJ,
        COALESCE(H1.CLQLJ, ' ') AS CLQLJ,
        COALESCE(H1.MANUAL, ' ') AS MANUAL,
        COALESCE(OM.DISBURSEDAMOUNT, 0.00) AS DISBURSEDAMOUNT,
        COALESCE(LP.LASTPAYDATE, 0) AS LASTPAYDATE,
        COALESCE(LP.LASTPAYAMOUNT, 0.00) AS LASTPAYAMOUNT
    FROM 
        (SELECT 
            CONCAT(LSBRNM, CONCAT(LSDLP, LSDLR)) AS UNIQID,
            SUM(LSAMTD) AS SCHEDULE_AMT,
            SUM(LSAMTP) AS PAID_AMT,
            SUM(LSAMTD) - SUM(LSAMTP) AS OUTSTANDING_AMT
         FROM KFILLIV.LSPF
         WHERE LSMVT = 'P'
         GROUP BY LSBRNM, LSDLP, LSDLR
        ) AS T1
    LEFT JOIN 
        (SELECT 
            CONCAT(LSBRNM, CONCAT(LSDLP, LSDLR)) AS UNIQID,
            MAX(LSAMTD) AS REPAYMENT_AMT
         FROM KFILLIV.LSPF
         WHERE LSMVT = 'P'
         GROUP BY LSBRNM, LSDLP, LSDLR
        ) AS T2 ON T1.UNIQID = T2.UNIQID
    LEFT JOIN 
        (SELECT 
            CONCAT(LSBRNM, CONCAT(LSDLP, LSDLR)) AS UNIQID,
            MIN(LSDTE) AS EARLIEST_DATE,
            MAX(T4PDAT) AS SYSTEM_DATE
         FROM KFILLIV.LSPF
         LEFT JOIN KFILLIV.T4PF ON 1=1
         WHERE (LSAMTP <> LSAMTD OR LSUP <> 0)
           AND LSLSC NOT IN ('', '0', '00', 'ST')
         GROUP BY LSBRNM, LSDLP, LSDLR
        ) AS T3 ON T1.UNIQID = T3.UNIQID
    LEFT JOIN 
        (SELECT 
            CONCAT(H1BRNM, CONCAT(H1LNP, H1DLR)) AS DEALUNQID,
            MAX(CASE WHEN H1LSC IN ('00', '01', '02', '03', '04') THEN H1LSC ELSE ' ' END) AS CLOBJ,
            MAX(CASE WHEN H1LSC IN ('0', '1', '2', '3', '4') THEN H1LSC ELSE ' ' END) AS CLQLJ,
            MAX(CASE WHEN H1MAN = 'Y' THEN H1MAN ELSE ' ' END) AS MANUAL
         FROM KFILLIV.H1PF
         GROUP BY H1BRNM, H1LNP, H1DLR
        ) AS H1 ON T1.UNIQID = H1.DEALUNQID
    LEFT JOIN 
        (SELECT 
            CONCAT(OMBRNM, CONCAT(OMDLP, OMDLR)) AS DEALUNQID,
            SUM(OMNWP) AS DISBURSEDAMOUNT
         FROM KFILLIV.OMPF
         INNER JOIN KFILLIV.V5PF 
           ON OMBRNM = V5BRNM 
          AND OMDLP = V5DLP 
          AND OMDLR = V5DLR
         WHERE OMMVT = 'P' 
           AND OMMVTS IN ('C', 'O') 
           AND OMPRF = 'P' 
           AND V5ARC = '' 
           AND V5TDT = 'L'
         GROUP BY OMBRNM, OMDLP, OMDLR
        ) AS OM ON T1.UNIQID = OM.DEALUNQID
    LEFT JOIN 
        (SELECT 
            CONCAT(OMBRNM, CONCAT(OMDLP, OMDLR)) AS DEALUNQID,
            MAX(OMDTE) AS LASTPAYDATE,
            SUM(OMNWR) AS LASTPAYAMOUNT
         FROM KFILLIV.OMPF
         WHERE OMMVT = 'P' 
           AND OMMVTS = 'T'
         GROUP BY OMBRNM, OMDLP, OMDLR
        ) AS LP ON T1.UNIQID = LP.DEALUNQID
) AS FINAL_QUERY
